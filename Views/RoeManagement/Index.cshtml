@{
    ViewBag.Title = "ROE 蒐集服務管理";
}

<h2>@ViewBag.Title</h2>

@if (TempData["Message"] != null)
{
    <div class="alert alert-@TempData["MessageType"] alert-dismissible fade show" role="alert">
        @TempData["Message"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

<div class="refresh-info">
    <i class="fas fa-sync-alt"></i>
    <strong>自動刷新：</strong>
    頁面將在 <span id="nextRefresh">5 分 00 秒</span> 後自動刷新
    <button id="manualRefresh" class="btn btn-sm btn-outline-primary ml-3">
        <i class="fas fa-redo"></i> 立即刷新
    </button>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">服務狀態</h4>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <tr>
                        <th style="width: 30%;">服務狀態</th>
                        <td>
                            @if (ViewBag.ServiceRunning)
                            {
                                <span class="badge badge-success badge-lg" style="background-color: #28a745; color: #ffffff; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                                    <i class="fas fa-check-circle"></i> 運行中
                                </span>
                            }
                            else
                            {
                                <span class="badge badge-danger badge-lg">
                                    <i class="fas fa-times-circle"></i> 已停止
                                </span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <th>快取數量</th>
                        <td><strong>@ViewBag.CacheCount</strong> 檔股票</td>
                    </tr>
                    <tr>
                        <th>最後更新時間</th>
                        <td>
                            @if (ViewBag.LastUpdate != null)
                            {
                                @(((DateTime)ViewBag.LastUpdate).ToString("yyyy-MM-dd HH:mm:ss"))
                            }
                            else
                            {
                                <span class="text-muted">尚無資料</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <th>執行週期</th>
                        <td>
                            每小時執行一次
                            @if (ViewBag.NextExecutionTime != null)
                            {
                                <br />
                                <small class="text-muted">
                                    下次執行時間：@(((DateTime)ViewBag.NextExecutionTime).ToString("yyyy-MM-dd HH:mm:ss"))
                                </small>
                                <br />
                                <small>
                                    <strong>距離下次執行：</strong>
                                    <span id="serviceCountdown" class="text-primary font-weight-bold">計算中...</span>
                                </small>
                            }
                            else
                            {
                                <br />
                                <small class="text-warning">
                                    <i class="fas fa-clock"></i> 服務剛啟動，首次執行中...
                                </small>
                            }
                        </td>
                    </tr>
                    <tr>
                        <th>每小時 API 限制</th>
                        <td>300 次呼叫 / 小時</td>
                    </tr>
                    <tr>
                        <th>每小時處理股票數</th>
                        <td>約 25 檔（每檔 12 個 API 呼叫，4個季度）</td>
                    </tr>
                    <tr>
                        <th>蒐集季度</th>
                        <td>
                            <span class="badge badge-dark" style="background-color: #343a40; color: #ffffff;">2025 Q1 (2025-03-31)</span>
                            <span class="badge badge-dark" style="background-color: #343a40; color: #ffffff;">2025 Q2 (2025-06-30)</span>
                            <span class="badge badge-dark" style="background-color: #343a40; color: #ffffff;">2025 Q3 (2025-09-30)</span>
                            <span class="badge badge-dark" style="background-color: #343a40; color: #ffffff;">2025 Q4 (2024-12-31)</span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">管理操作</h5>
            </div>
            <div class="card-body">
                <h6>清除快取</h6>
                <p class="text-muted">清除所有已儲存的 ROE 快取資料，服務會自動重啟並重頭開始抓取。</p>
                @using (Html.BeginForm("ClearCache", "RoeManagement", FormMethod.Post))
                {
                    <button type="submit" class="btn btn-warning" onclick="return confirm('確定要清除所有快取嗎？\n\n服務將重新啟動並從頭開始抓取所有股票資料。');">
                        <i class="fas fa-trash"></i> 清除快取並重啟
                    </button>
                }

                <hr />

                <h6>重啟服務</h6>
                <p class="text-muted">重新啟動背景蒐集服務。</p>
                @using (Html.BeginForm("RestartService", "RoeManagement", FormMethod.Post))
                {
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-sync"></i> 重啟服務
                    </button>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">服務說明</h5>
            </div>
            <div class="card-body">
                <h6>運作方式：</h6>
                <ul>
                    <li>每小時自動執行一次</li>
                    <li>只蒐集尚未有快取的股票</li>
                    <li>每小時最多處理 25 檔股票</li>
                    <li>每檔股票需要 12 個 API 呼叫（4個季度 × 3次）</li>
                    <li>自動儲存到 App_Data/roe_cache.json</li>
                </ul>

                <h6>蒐集進度：</h6>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" 
                         style="width: @(ViewBag.CacheCount > 0 ? Math.Min(100, (ViewBag.CacheCount / 1700.0) * 100) : 0)%" 
                         aria-valuenow="@ViewBag.CacheCount" aria-valuemin="0" aria-valuemax="1700">
                        @ViewBag.CacheCount / ~1700
                    </div>
                </div>
                <small class="text-muted">預估約需 68 小時完成全部股票蒐集（1700 ÷ 25 = 68 小時）</small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">快速連結</h5>
            </div>
            <div class="card-body">
                @Html.ActionLink("市值+ROE 排行", "Index", "Etf00919", null, new { @class = "btn btn-primary" })
                @Html.ActionLink("返回首頁", "Index", "Home", null, new { @class = "btn btn-secondary" })
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // ========== 頁面自動刷新設定 ==========
            var refreshInterval = 5 * 60 * 1000; // 5 分鐘（毫秒）
            var pageCountdownSeconds = 5 * 60; // 5 分鐘（秒）
            var pageCountdownTimer;
            var refreshTimer;

            // 更新頁面刷新倒數計時顯示
            function updatePageCountdown() {
                var minutes = Math.floor(pageCountdownSeconds / 60);
                var seconds = pageCountdownSeconds % 60;
                var timeString = minutes + ' 分 ' + (seconds < 10 ? '0' : '') + seconds + ' 秒';
                $('#nextRefresh').text(timeString);
                
                pageCountdownSeconds--;
                
                if (pageCountdownSeconds < 0) {
                    pageCountdownSeconds = 5 * 60;
                }
            }

            // 手動刷新按鈕
            $('#manualRefresh').click(function() {
                location.reload();
            });

            // 啟動頁面刷新倒數計時（每秒更新）
            pageCountdownTimer = setInterval(updatePageCountdown, 1000);
            
            // 啟動自動刷新（每 5 分鐘）
            refreshTimer = setTimeout(function() {
                location.reload();
            }, refreshInterval);

            // 初始化頁面刷新倒數
            updatePageCountdown();

            // ========== 背景服務執行倒數計時 ==========
            @if (ViewBag.NextExecutionTime != null)
            {
                <text>
                var nextExecutionTime = new Date('@(((DateTime)ViewBag.NextExecutionTime).ToString("yyyy-MM-dd HH:mm:ss"))');
                var serviceCountdownTimer;

                function updateServiceCountdown() {
                    var now = new Date();
                    var diff = nextExecutionTime - now;
                    
                    if (diff @Html.Raw("<=") 0) {
                        $('#serviceCountdown').html('@Html.Raw("<span class=\"text-success\"><i class=\"fas fa-check-circle\"></i> 正在執行中...</span>")');
                        clearInterval(serviceCountdownTimer);
                        // 2 秒後刷新頁面以更新狀態
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                        return;
                    }
                    
                    var hours = Math.floor(diff / (1000 * 60 * 60));
                    var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    var seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    var timeString = '';
                    if (hours @Html.Raw(">") 0) {
                        timeString += hours + ' 小時 ';
                    }
                    timeString += minutes + ' 分 ' + (seconds @Html.Raw("<") 10 ? '0' : '') + seconds + ' 秒';
                    
                    $('#serviceCountdown').text(timeString);
                }

                // 啟動背景服務倒數計時（每秒更新）
                serviceCountdownTimer = setInterval(updateServiceCountdown, 1000);
                
                // 初始化背景服務倒數
                updateServiceCountdown();
                </text>
            }
        });
    </script>

    <style>
        .card {
            margin-bottom: 20px;
        }

        .badge-lg {
            font-size: 1.2em;
            padding: 0.6em 1em;
        }

        .table th {
            background-color: #f8f9fa;
        }

        .refresh-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .refresh-info i {
            color: #2196F3;
            margin-right: 8px;
        }

        #nextRefresh {
            font-weight: bold;
            color: #1976D2;
        }
    </style>
}
