@model List<MvcWebCrawler.Models.MarketCap>

@{
    ViewBag.Title = "查詢上市上櫃市值排行";
}

<h2>@ViewBag.Title</h2>

<div class="row mb-3">
    <div class="col-md-8">
        <form method="get" action="@Url.Action("Index", "MarketCap")" class="form-inline">
            <label for="market" class="mr-2">市場別：</label>
            <select name="market" id="market" class="form-control mr-2">
                <option value="all" @(ViewBag.SelectedMarket == "all" ? "selected" : "")>全部</option>
                <option value="listed" @(ViewBag.SelectedMarket == "listed" ? "selected" : "")>上市</option>
                <option value="otc" @(ViewBag.SelectedMarket == "otc" ? "selected" : "")>上櫃</option>
            </select>
            
            <label for="topN" class="mr-2 ml-3">顯示筆數：</label>
            <select name="topN" id="topN" class="form-control mr-2">
                <option value="20" @(ViewBag.TopN == 20 ? "selected" : "")>前 20 名</option>
                <option value="50" @(ViewBag.TopN == 50 ? "selected" : "")>前 50 名</option>
                <option value="100" @(ViewBag.TopN == 100 ? "selected" : "")>前 100 名</option>
                <option value="200" @(ViewBag.TopN == 200 ? "selected" : "")>前 200 名</option>
                <option value="300" @(ViewBag.TopN == 300 ? "selected" : "")>前 300 名</option>
                <option value="400" @(ViewBag.TopN == 400 ? "selected" : "")>前 400 名</option>
                <option value="500" @(ViewBag.TopN == 500 ? "selected" : "")>前 500 名</option>
            </select>
            
            <button type="submit" class="btn btn-primary">查詢</button>
        </form>
    </div>
</div>

<div class="alert alert-info">
    <strong>市值排行說明：</strong>
    <ul class="mb-0">
        <li>市值 = 股價 × 發行股數</li>
        <li>市值越大，代表公司規模越大</li>
        <li>資料每日更新</li>
    </ul>
</div>

@if (Model != null && Model.Count > 0)
{
    var listedCount = Model.Count(x => x.Market == "上市");
    var otcCount = Model.Count(x => x.Market == "上櫃");
    
    <div class="alert alert-success">
        <strong>查詢結果：</strong>共找到 @Model.Count 家公司
        <span class="ml-3">市場：<strong>@(ViewBag.SelectedMarket == "all" ? "全部" : ViewBag.SelectedMarket == "listed" ? "上市" : "上櫃")</strong></span>
        @if (ViewBag.SelectedMarket == "all")
        {
            <span class="ml-2">（上市: @listedCount 家，上櫃: @otcCount 家）</span>
        }
    </div>
}
else
{
    <div class="alert alert-warning">
        <strong>查無資料</strong>
        <p class="mb-0">請稍候重試或檢查 API 連線狀態</p>
    </div>
}

<div class="table-responsive">
    <table class="table table-striped table-bordered table-hover table-sm">
        <thead class="thead-dark">
            <tr>
                <th class="text-center" style="width: 60px;">排名</th>
                <th>股票代號</th>
                <th>股票名稱</th>
                <th>產業別</th>
                <th class="text-right">市值</th>
                <th class="text-right">收盤價</th>
                <th class="text-center">漲跌</th>
                <th class="text-right">漲跌價差</th>
                <th class="text-right">漲跌幅</th>
                <th class="text-right">成交量(張)</th>
                <th class="text-center" style="width: 80px;">市場別</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Count > 0)
            {
                foreach (var item in Model)
                {
                    var changeColor = MvcWebCrawler.Controllers.MarketCapController.GetChangeColor(item.Change);
                    
                    <tr>
                        <td class="text-center">
                            @if (item.Rank == 1)
                            {
                                <span class="rank-badge rank-gold">@item.Rank</span>
                            }
                            else if (item.Rank == 2)
                            {
                                <span class="rank-badge rank-silver">@item.Rank</span>
                            }
                            else if (item.Rank == 3)
                            {
                                <span class="rank-badge rank-bronze">@item.Rank</span>
                            }
                            else
                            {
                                <span class="text-dark font-weight-bold">@item.Rank</span>
                            }
                        </td>
                        <td><strong>@item.StockId</strong></td>
                        <td><strong>@item.StockName</strong></td>
                        <td class="text-muted">@item.Industry</td>
                        <td class="text-right text-primary"><strong>@MvcWebCrawler.Controllers.MarketCapController.FormatMarketValue(item.MarketValue)</strong></td>
                        <td class="text-right">@MvcWebCrawler.Controllers.MarketCapController.FormatPrice(item.ClosePrice)</td>
                        <td class="text-center @changeColor">@item.ChangeDirection</td>
                        <td class="text-right @changeColor">@MvcWebCrawler.Controllers.MarketCapController.FormatPrice(item.Change)</td>
                        <td class="text-right @changeColor">@MvcWebCrawler.Controllers.MarketCapController.FormatPercent(item.ChangePercent)</td>
                        <td class="text-right">@MvcWebCrawler.Controllers.MarketCapController.FormatNumber(item.Volume)</td>
                        <td class="text-center">
                            @if (item.Market == "上市")
                            {
                                <span class="badge badge-primary market-badge">上市</span>
                            }
                            else if (item.Market == "上櫃")
                            {
                                <span class="badge badge-dark market-badge" style="background-color: #6c757d;">上櫃</span>
                            }
                            else
                            {
                                <span class="badge badge-secondary market-badge">@item.Market</span>
                            }
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="11" class="text-center">
                        <div class="py-5">
                            <h4 class="text-muted">尚無資料</h4>
                            <p class="text-muted">請檢查網路連線或稍後再試</p>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (Model != null && Model.Count > 0)
{
    <div class="row mt-4">
        <div class="col-md-12">
            <p class="text-muted">
                資料更新時間：@(Model.FirstOrDefault()?.UpdateDate ?? DateTime.Now.ToString("yyyy-MM-dd"))
            </p>
        </div>
    </div>
}

<button id="backToTop" class="btn btn-primary" title="回到頂部">
    <span class="arrow-up">↑</span>
    <span>TOP</span>
</button>

@section scripts {
    <script>
        $(document).ready(function() {
            var $backToTop = $('#backToTop');

            $(window).scroll(function() {
                if ($(this).scrollTop() > 300) {
                    $backToTop.fadeIn();
                } else {
                    $backToTop.fadeOut();
                }
            });

            $backToTop.click(function() {
                $('html, body').animate({
                    scrollTop: 0
                }, 600);
                return false;
            });
        });
    </script>

    <style>
        .fw-bold, .font-weight-bold {
            font-weight: 900 !important;
        }

        .text-danger.fw-bold {
            color: #dc3545 !important;
            font-weight: 900 !important;
        }

        .text-success.fw-bold {
            color: #28a745 !important;
            font-weight: 900 !important;
        }

        .rank-badge {
            display: inline-block;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 0.25rem;
            border: 2px solid;
        }

        .rank-gold {
            background-color: #FFD700;
            color: #000;
            border-color: #FFA500;
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.5);
        }

        .rank-silver {
            background-color: #C0C0C0;
            color: #000;
            border-color: #A9A9A9;
            box-shadow: 0 2px 4px rgba(192, 192, 192, 0.5);
        }

        .rank-bronze {
            background-color: #CD7F32;
            color: #fff;
            border-color: #B87333;
            box-shadow: 0 2px 4px rgba(205, 127, 50, 0.5);
        }

        .market-badge {
            font-size: 0.9rem;
            padding: 0.4rem 0.7rem;
        }

        .badge {
            border: none;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #backToTop {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
            transition: all 0.3s ease;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #backToTop:hover {
            background-color: #0056b3;
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 123, 255, 0.6);
        }

        #backToTop .arrow-up {
            font-size: 20px;
            line-height: 1;
            margin-bottom: 2px;
        }

        #backToTop span:last-child {
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        @@media (max-width: 768px) {
            #backToTop {
                width: 50px;
                height: 50px;
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
}
